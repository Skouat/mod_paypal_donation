<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
	<header>
		<license><![CDATA[http://opensource.org/licenses/gpl-license.php GNU General Public License v2]]></license>
		<title lang="en"><![CDATA[Update from “Stoker 4.0's Paypal Donation MOD 1.0.3” to “Paypal Donation MOD 1.0.1”]]></title>
		<title lang="fr"><![CDATA[Mise à jour de “Paypal Donation MOD 1.0.3” de Stoker 4.0 vers “Paypal Donation MOD 1.0.1”]]></title>
		<description lang="en"><![CDATA[Those update instructions help you to migrate from “Stoker 4.0's Paypal Donation MOD 1.0.3” to this “Paypal Donation MOD” version.]]></description>
		<description lang="fr"><![CDATA[Ces instructions de mise à jour vous aiderons à migrer de “Paypal Donation MOD de Stoker 4.0” vers cette version de “Paypal Donation MOD”]]></description>
		<author-group>
			<author>
				<realname><![CDATA[Skouat]]></realname>
				<username><![CDATA[Skouat]]></username>
				<homepage><![CDATA[http://www.ultima-world.com]]></homepage>
				<contributions-group>
					<contributions status="current" from="2009-08-02" position="Developer"/>
				</contributions-group>
			</author>
		</author-group>

		<mod-version>1.0.0</mod-version>

		<installation>
			<level>easy</level>
			<time>300</time>
			<target-version>3.0.10</target-version>
		</installation>

		<history>
			<entry>
				<date>2012-02-04</date>
				<rev-version>1.0.0 of this MOD</rev-version>
				<changelog lang="en">
					<change>Too many change... All the code was rewritten.</change>
				</changelog>
				<changelog lang="fr">
					<change>Trop de changement... Tout le code a été récrit.</change>
				</changelog>
			</entry>
			<entry>
				<date>2011-11-23</date>
				<rev-version>1.0.3 of Stoker 4.0's MOD</rev-version>
				<changelog lang="en">
					<change>Last version of Stoker 4.0's MOD.</change>
				</changelog>
				<changelog lang="fr">
					<change>Dernière version du MOD de Stoker 4.0.</change>
				</changelog>
			</entry>
		</history>
		<link-group>
			<link type="parent" href="../../install.xml" lang="en">Parent MOD installation</link>
		</link-group>
	</header>
	<action-group>
		<sql><![CDATA[DROP TABLE  `phpbb_donation`]]></sql>
		<sql><![CDATA[DELETE FROM `phpbb_config` WHERE `phpbb_config`.`config_name` = 'donation_achievement';
DELETE FROM `phpbb_config` WHERE `phpbb_config`.`config_name` = 'donation_achievement_enable';
DELETE FROM `phpbb_config` WHERE `phpbb_config`.`config_name` = 'donation_email';
DELETE FROM `phpbb_config` WHERE `phpbb_config`.`config_name` = 'donation_enable';
DELETE FROM `phpbb_config` WHERE `phpbb_config`.`config_name` = 'donation_goal';
DELETE FROM `phpbb_config` WHERE `phpbb_config`.`config_name` = 'donation_goal_currency';
DELETE FROM `phpbb_config` WHERE `phpbb_config`.`config_name` = 'donation_goal_currency_enable';
DELETE FROM `phpbb_config` WHERE `phpbb_config`.`config_name` = 'donation_goal_enable';
DELETE FROM `phpbb_config` WHERE `phpbb_config`.`config_name` = 'donation_index_enable';
DELETE FROM `phpbb_config` WHERE `phpbb_config`.`config_name` = 'donation_mod_version';]]></sql>
		<sql><![CDATA[DELETE FROM `phpbb_modules` WHERE `phpbb_modules`.`module_langname` = 'ACP_DONATION_MOD';
DELETE FROM `phpbb_modules` WHERE `phpbb_modules`.`module_langname` = 'DONATION_CONFIG';]]></sql>
		<copy>
			<file from="root/donate.php" to="donate.php" />
			<file from="root/install_donation_mod.php" to="install_donation_mod.php" />
			<file from="root/adm/style/acp_donation.html" to="adm/style/acp_donation.html" />
			<file from="root/images/donation/*.*" to="images/donation/*.*" />
			<file from="root/includes/acp/*.*" to="includes/acp/*.*" />
			<file from="root/includes/functions_donation.php" to="includes/functions_donation.php" />
			<file from="root/language/en/mods/*.*" to="language/en/mods/*.*" />
			<file from="root/styles/prosilver/imageset/en/donate.gif" to="styles/prosilver/imageset/en/donate.gif" />
			<file from="root/styles/prosilver/template/donate/*.*" to="styles/prosilver/template/donate/*.*" />
			<file from="root/styles/prosilver/theme/donation.css" to="styles/prosilver/theme/donation.css" />
			<file from="root/umil/*.*" to="umil/*.*" />
		</copy>
		<delete>
			<file name="images/loader.gif" />
			<file name="images/prog_green.png" />
			<file name="images/prog_grey.png" />
			<file name="styles/prosilver/theme/donate/cancel_body.html" />
			<file name="styles/prosilver/theme/donate/success_body.html" />
		</delete>
		<open src="index.php">
			<edit>
				<find><![CDATA[$user->setup('viewforum');]]></find>
				<action type="after-add"><![CDATA[//-- mod : Paypal donation --------------------------------------------------------
//-- add
if ($config['donation_enable'] && $config['donation_stats_index_enable'])
{
	$user->add_lang('mods/donate');
	include($phpbb_root_path . 'includes/functions_donation.' . $phpEx);
}
//-- end : Paypal donation --------------------------------------------------------
]]></action>
			</edit>
			<edit>
				<find><![CDATA[if (!empty($config['donation_index_enable']) && $config['donation_index_enable'] == 1)
{
$user->add_lang('mods/donate');
$template->assign_vars(array(	
	'DONATION_ACHIEVEMENT_ENABLE'		=> (isset($config['donation_achievement_enable'])) ? $config['donation_achievement_enable']:false,
	'DONATION_ACHIEVEMENT'				=> (isset($config['donation_achievement'])) ? $config['donation_achievement']:false,
	'DONATION_INDEX_ENABLE'				=> (isset($config['donation_index_enable'])) ? $config['donation_index_enable']:false,
	'DONATION_GOAL_ENABLE'				=> (isset($config['donation_goal_enable'])) ? $config['donation_goal_enable']:false,
	'DONATION_GOAL'						=> (isset($config['donation_goal'])) ? $config['donation_goal']:false,
	'DONATION_GOAL_CURRENCY_ENABLE'		=> (isset($config['donation_goal_currency_enable'])) ? $config['donation_goal_currency_enable']:false,
	'DONATION_GOAL_CURRENCY'			=> (isset($config['donation_goal_currency'])) ? $config['donation_goal_currency']:false,
));
}

if (!empty($config['donation_goal_enable']) &&  $config['donation_goal'] > 0)
{
$donation_goal_number = ($config['donation_achievement'] * 100) / $config['donation_goal'];
$template->assign_vars(array(
   'DONATION_GOAL_NUMBER'            => $donation_goal_number,
));
}]]></find>
				<action type="replace-with"><![CDATA[//-- mod : Paypal donation --------------------------------------------------------
//-- add
if ($config['donation_enable'] && $config['donation_stats_index_enable'])
{
	$template->assign_vars(array(
		'DONATION_STATS_INDEX_ENABLE'	=> (!empty($config['donation_stats_index_enable'])) ? true : false,
		'DONATION_RAISED_ENABLE'		=> (!empty($config['donation_raised_enable'])) ? true : false,
		'DONATION_RAISED'				=> (!empty($config['donation_raised'])) ? $config['donation_raised'] : 0,
		'DONATION_GOAL_ENABLE'			=> (!empty($config['donation_goal_enable'])) ? true : false,
		'DONATION_GOAL'					=> (!empty($config['donation_goal'])) ? $config['donation_goal'] : 0,
		'DONATION_USED_ENABLE'			=> (!empty($config['donation_used_enable'])) ? true : false,
		'DONATION_USED'					=> (!empty($config['donation_used'])) ? $config['donation_used'] : 0,
		'DONATION_CURRENCY_ENABLE'		=> (!empty($config['donation_currency_enable'])) ? true : false,
		'DONATION_CURRENCY'				=> donation_item_list((int) $config['donation_default_currency'], 'currency', 'default_currency', $user->lang['CURRENCY_DEFAULT']),
	));

	if ($config['donation_goal_enable'] && (int) $config['donation_goal'] > 0)
	{
		donation_percent_stats('GOAL_NUMBER', (int) $config['donation_raised'], (int) $config['donation_goal']);
	}

	if ($config['donation_used_enable'] && (int) $config['donation_raised'] > 0 && (int) $config['donation_used'] > 0)
	{
		donation_percent_stats('USED_NUMBER', (int) $config['donation_used'], (int) $config['donation_raised']);
	}
}
//-- end : Paypal donation --------------------------------------------------------
]]></action>
			</edit>
		</open>
		<open src="viewonline.php">
			<edit>
				<remove><![CDATA[		case 'donate':
			$location = $user->lang['VIEWING_DONATE'];
			$location_url = append_sid("{$phpbb_root_path}donate.$phpEx");
		break;
]]></remove>
			</edit>
			<edit>
				<find><![CDATA[		default:
			$location = $user->lang['INDEX'];]]></find>
				<action type="before-add"><![CDATA[//-- mod : Paypal Donation --------------------------------------------------------
//-- add
		case 'donate':
			$location = $user->lang['VIEWING_DONATE'];
			$location_url = append_sid("{$phpbb_root_path}donate.$phpEx");
		break;
//-- end : Paypal Donation --------------------------------------------------------
]]></action>
			</edit>
		</open>
		<open src="includes/constants.php">
			<edit>
				<find><![CDATA[// BEGIN Donation MOD
define('DONATION_TABLE',			$table_prefix . 'donation');
// END Donation MOD
]]></find>
				<action type="replace-with"><![CDATA[//-- mod : Paypal Donation --------------------------------------------------------
//-- add
define('DONATION_ITEM_TABLE',			$table_prefix . 'donation_item');
//-- end : Paypal Donation --------------------------------------------------------
]]></action>
			</edit>
		</open>
		<open src="includes/functions.php">
			<edit>
				<remove><![CDATA[// BEGIN Donation Mod
		'U_DONATE'				=> append_sid("{$phpbb_root_path}donate.$phpEx"),
		'S_DONATE_ENABLED'		=> (!empty($config['donation_enable'])) ? true : false,
// END Donation Mod]]></remove>
			</edit>
			<edit>
				<find><![CDATA[		'A_COOKIE_SETTINGS'		=> addslashes('; path=' . $config['cookie_path'] . ((!$config['cookie_domain'] || $config['cookie_domain'] == 'localhost' || $config['cookie_domain'] == '127.0.0.1') ? '' : '; domain=' . $config['cookie_domain']) . ((!$config['cookie_secure']) ? '' : '; secure')),
	));
]]></find>
				<action type="after-add"><![CDATA[//-- mod : Paypal Donation --------------------------------------------------------
//-- add
	if ((!empty($config['donation_enable']) && !empty($config['donation_account_id'])) || (!empty($config['paypal_sandbox_enable']) && !empty($config['paypal_sandbox_address'])))
	{
		$template->assign_vars(array(
			'U_DONATE'			=> append_sid("{$phpbb_root_path}donate.$phpEx"),
			'S_DONATE_ENABLED'	=> true,
		));
	}
//-- end : Paypal Donation --------------------------------------------------------
]]></action>
			</edit>
		</open>
		<open src="language/en/common.php">
			<edit>
				<find><![CDATA[// BEGIN Donation MOD
$lang = array_merge($lang, array(
	'DONATEINDEX'				=> 'Donate',
	'VIEWING_DONATE'			=> 'Viewing Donation page',
));
// Donation MOD]]></find>
				<action type="replace-with"><![CDATA[//-- mod : Paypal Donation --------------------------------------------------------
//-- add
$lang = array_merge($lang, array(
	'DONATEINDEX'				=> 'Donate',
	'VIEWING_DONATE'			=> 'Viewing Donation page',
));
//-- end : Paypal Donation --------------------------------------------------------]]></action>
			</edit>
		</open>
			<open src="styles/prosilver/template/index_body.html">
			<edit>
				<find><![CDATA[<!-- IF DONATION_INDEX_ENABLE and (DONATION_ACHIEVEMENT_ENABLE or DONATION_GOAL_ENABLE) -->
	<h3><a href="{U_DONATE}">{L_DONATIONS_INDEX}</a></h3>
	<!-- IF DONATION_GOAL_ENABLE and DONATION_ACHIEVEMENT_ENABLE and DONATION_GOAL > 0 -->
	<div style="background:url('{ROOT_PATH}images/prog_grey.png') repeat-x; background-color: #cccccc; border: 1px solid black; width:100%; margin-top: 2px;"><div style="background:url('{ROOT_PATH}images/prog_green.png') repeat-x;background-color: #008040; color: white; font-weight:bold; max-width:100%;  width:{DONATION_GOAL_NUMBER}%; height:24px;"><span style="padding-left:25px; font-size:18px;">{DONATION_GOAL_NUMBER}%</span></div></div>
	<!-- ENDIF -->
	<p style="text-align:center;"><!-- IF DONATION_ACHIEVEMENT_ENABLE -->{L_WE_HAVE_ACHIEVED} <strong><!-- IF DONATION_ACHIEVEMENT > 0 -->{DONATION_ACHIEVEMENT}<!-- ELSE -->{DONATION_GOAL_NUMBER}<!-- ENDIF --></strong><!-- IF DONATION_GOAL_CURRENCY_ENABLE --> {DONATION_GOAL_CURRENCY}<!-- ENDIF --> {L_WE_HAVE_ACHIEVED_IN}<!-- ENDIF --><!-- IF DONATION_GOAL_ENABLE and DONATION_GOAL > 0 --> {L_OUR_DONATION_GOAL} <strong>{DONATION_GOAL}</strong><!-- IF DONATION_GOAL_CURRENCY_ENABLE --> {DONATION_GOAL_CURRENCY}<!-- ENDIF -->.<!-- ENDIF --></p>
<!-- ENDIF -->]]></find>
				<action type="replace-with"><![CDATA[<!-- IF DONATION_STATS_INDEX_ENABLE and (DONATION_RAISED_ENABLE or DONATION_GOAL_ENABLE or DONATION_USED_ENABLE) -->
	<!-- INCLUDE donate/donate_stats.html -->
<!-- ENDIF -->]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/theme/stylesheet.css">
			<edit>
				<find><![CDATA[@import url("colours.css");]]></find>
				<action type="after-add"><![CDATA[@import url("donation.css");
]]></action>
			</edit>
		</open>
		<php-installer><![CDATA[install_donation_mod.php]]></php-installer>

		<diy-instructions lang="en"><![CDATA[--------- Update instructions ---------
- Upload all included files.
- If you haven't already do it, now execute SQL instructions.
- Go to ACP, refresh your style and purge your cache
- Run the installer
- Set the Paypal Donation Mod settings under the .MOD tab.]]></diy-instructions>
		<diy-instructions lang="fr"><![CDATA[--------- instructions de mise à jour ---------
- Transférez l'ensemble des fichiers.
- Si ce n'est pas déjà fait, exécutez les requêtes SQL.
- Allez dans l'ACP, rafraichissez les styles et purgez le cache.
- Lancez le fichier d'installation
- Configurez le MOD depuis le panneau d'administration dans l'onglet “.MOD”.]]></diy-instructions>
	</action-group>
</mod>